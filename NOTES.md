# Notes - modular-flow-engine

Brief context for agents working with this package.

## Build / Run

No build step required. Pure Python.

```bash
# Interactive mode (shows flow picker)
python runner.py

# Run a specific flow
python runner.py flows/simple_test.json

# With inputs
python runner.py flows/input_test.json --input data_file=/path/to/data.txt

# List available flows
python runner.py --list-flows

# Validate without running
python runner.py flows/my_flow.json --dry-run
```

**Requirements:** Python 3.10+, packages in requirements.txt

## HTTP Service

The flow engine provides an HTTP API for programmatic access.

### Start Service

```bash
# Start on default port 9847
python server.py

# Custom port and workers
python server.py --port 8080 --workers 4

# Or via systemd
systemctl --user start flow-engine
```

**Port:** 9847 (localhost only)
**Workers:** 2 (configurable via FLOW_ENGINE_WORKERS env var)

### API Endpoints

| Endpoint | Purpose |
|----------|---------|
| `GET /flows` | List available flows |
| `GET /flows/{name}` | Get flow schema (inputs, returns) |
| `POST /flows/{name}/execute` | Execute flow (sync or async) |
| `POST /flows/{name}/validate` | Validate inputs (dry-run) |
| `GET /jobs` | List recent jobs |
| `GET /jobs/{job_id}` | Get job status/result |
| `DELETE /jobs/{job_id}` | Cancel queued job |
| `GET /components` | List component types |
| `GET /components/{type}/schema` | Get component manifest |
| `GET /health` | Health check with queue status |
| `GET /docs` | OpenAPI/Swagger UI |

### Example API Usage

```bash
# Health check
curl http://localhost:9847/health

# List flows
curl http://localhost:9847/flows

# Execute flow (sync)
curl -X POST http://localhost:9847/flows/with_inputs/execute \
  -H "Content-Type: application/json" \
  -d '{"inputs": {"data_file": "/tmp/test.txt"}}'

# Execute flow (async - returns job_id)
curl -X POST "http://localhost:9847/flows/with_inputs/execute?sync=false" \
  -H "Content-Type: application/json" \
  -d '{"inputs": {"data_file": "/tmp/test.txt"}}'

# Check job status
curl http://localhost:9847/jobs/{job_id}
```

## Path Dependencies

All paths are relative to package root. No hardcoded absolute paths in code.

- `flows/` - Workflow definition files (JSON)
- `components/` - Built-in component library
- `composites/` - Reusable component groups
- `config/` - API keys (gitignored)
- `results/` - Output files (gitignored)
- `server/` - HTTP API service package

## Key Architecture

- **Flows**: JSON workflow definitions with components and flow steps
- **Components**: Source (load data), Transform (process), Sink (output)
- **Engine**: Executes flows, handles loops, error recovery
- **Context**: Manages variables, scoping, and destination writers
- **HTTP Service**: FastAPI-based API

### Output Destinations

Sinks write to configurable destinations using `context.write()`:

| Destination | Description |
|-------------|-------------|
| `return` | Include in API response (`ExecutionResult.returns`) |
| `file` | Write to JSON file (requires `path` config) |
| `console` | Print to stdout |

```json
{
  "type": "sink/collector",
  "config": {
    "destinations": ["return", "file"],
    "path": "results.json"
  }
}
```

- `sink/collector` defaults to `["return"]` if not specified
- `sink/json_writer` defaults to `["file"]` if not specified

## Integration

- Results saved as JSON for programmatic consumption
- Flows are declarative JSON - can be generated by other tools
- HTTP API enables integration with other services

## Service Management

```bash
# Enable service
systemctl --user enable flow-engine

# Start/stop/restart
systemctl --user start flow-engine
systemctl --user stop flow-engine
systemctl --user restart flow-engine

# View logs
journalctl --user -u flow-engine -f
```

## Known Issues

None currently.
