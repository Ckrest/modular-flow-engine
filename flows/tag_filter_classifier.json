{
  "name": "tag_filter_classifier",
  "description": "Classify tags into filter categories for female-solo content curation",

  "settings": {
    "output_mode": "normal"
  },

  "components": {
    "api_key": {
      "type": "source/api_key",
      "config": {
        "key_name": "openrouter",
        "required": true
      }
    },

    "tags": {
      "type": "source/text_list",
      "config": {
        "path": "flows/samples/test_filter_tags.txt"
      }
    },

    "system_instruction": {
      "type": "source/literal",
      "config": {
        "value": "You are a content tag classifier for an anime image generation system. Your job is to identify tags that should be FILTERED OUT from a female-solo content collection.\n\nFILTER CATEGORIES (return one of these, or 'pass' if the tag is acceptable):\n\n1. male_presence - Male anatomy, male characters, or heterosexual acts (penis, balls, 1boy, hetero, cum_on_face from male, fellatio, etc.)\n\n2. anal_content - Any anal-related content (anal, anus, anal_sex, spread_anus, etc.)\n\n3. non_human_partner - Monster/creature partners, NOT fantasy races (tentacles, furry, demon as partner, orc, slime - but elf/devil_horns/angel_wings are OK)\n\n4. violence_gore - Blood, wounds, death, violence (blood, gore, corpse, dismemberment, stab)\n\n5. bodily_waste - Excrement, urine, vomit (scat, poop, urine, peeing, vomit, watersports)\n\n6. extreme_fetish - Extreme body modification or forced scenarios (inflation, breast_expansion, forced_lactation, milking_machine - regular lactation is OK)\n\n7. pubic_hair - Any pubic hair visibility (pubic_hair, shaved_pussy, female_pubic_hair)\n\nTags that ARE ALLOWED (return 'pass'):\n- Female anatomy (breasts, nipples, pussy, clitoris)\n- Female pleasure (masturbation, orgasm, squirting, ahegao)\n- BDSM/bondage (shibari, collar, bondage, slave)\n- Sex toys (dildo, vibrator, object_insertion)\n- Fantasy races (elf, devil, succubus as CHARACTER not partner)\n- Regular lactation\n- All clothing, hair, expressions, poses\n\nRespond with ONLY the category name or 'pass'. Nothing else."
      }
    },

    "build_prompt": {
      "type": "transform/template",
      "config": {}
    },

    "classify": {
      "type": "transform/openrouter",
      "config": {
        "model": "anthropic/claude-sonnet-4",
        "temperature": 0.0,
        "max_tokens": 20,
        "timeout": 30
      }
    },

    "results_collector": {
      "type": "sink/collector",
      "config": {
        "fields": ["tag", "category", "raw_response"]
      }
    },

    "report": {
      "type": "sink/json_writer",
      "config": {
        "path": "filter_classification_results.json"
      }
    }
  },

  "flow": [
    {"source": "api_key"},
    {"source": "tags"},
    {"source": "system_instruction"},

    {
      "loop": {
        "over": "tags.items",
        "as": "tag",
        "steps": [
          {
            "call": "build_prompt",
            "inputs": {
              "template": "Classify this tag: {tag}",
              "tag": "{tag}"
            },
            "outputs": {
              "result": "prompt"
            }
          },

          {
            "call": "classify",
            "inputs": {
              "prompt": "{prompt}",
              "system_prompt": "{system_instruction.value}",
              "api_key": "{api_key.key}"
            },
            "outputs": {
              "response": "classification"
            }
          },

          {
            "call": "results_collector",
            "inputs": {
              "tag": "{tag}",
              "category": "{classification}",
              "raw_response": "{classification}"
            }
          }
        ]
      }
    },

    {"sink": "results_collector"},

    {
      "call": "report",
      "inputs": {
        "data": {
          "total_tags": "{results_collector.count}",
          "results": "{results_collector.items}"
        }
      }
    }
  ],

  "error_handling": {
    "default": "retry",
    "max_retries": 3
  }
}
