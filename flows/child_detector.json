{
  "name": "child_detector",
  "description": "Detect child-presenting characters using optimized 5-question voting (â‰¥2 yes = flagged)",

  "settings": {
    "output_mode": "normal",
    "model": "meta-llama/llama-3.3-70b-instruct"
  },

  "components": {
    "api_key": {
      "type": "source/api_key",
      "config": {
        "key_name": "openrouter",
        "required": true
      }
    },

    "characters": {
      "type": "source/text_list",
      "config": {
        "path": "flows/samples/FemaleCharList.txt"
      }
    },

    "questions": {
      "type": "source/literal",
      "config": {
        "value": [
          "Does {item} appear to be under 12 years old based on their visual design?",
          "Would you estimate {item}'s apparent age as elementary school age (6-11)?",
          "Does {item} have the wide-eyed, innocent look common in child characters?",
          "Is {item}'s physique clearly that of a prepubescent child?",
          "Is {item} depicted with the lanky, undeveloped frame of a young child?"
        ]
      }
    },

    "system_instruction": {
      "type": "source/literal",
      "config": {
        "value": "You are a precise visual classifier for anime/game characters. Answer ONLY 'yes' or 'no' to the question about the character's apparent visual age. Base your answer purely on how the character is typically depicted visually, not on lore or stated ages. No explanations."
      }
    },

    "build_prompt": {
      "type": "transform/template",
      "config": {}
    },

    "ask_model": {
      "type": "transform/openrouter",
      "config": {
        "temperature": 0.0,
        "max_tokens": 10
      }
    },

    "parse_answer": {
      "type": "transform/yesno_parser",
      "config": {
        "strict": false
      }
    },

    "votes_collector": {
      "type": "sink/collector",
      "config": {
        "fields": ["character", "question_index", "question", "answer", "is_yes"]
      }
    },

    "item_progress": {
      "type": "transform/item_progress",
      "config": {
        "item_field": "character",
        "vote_field": "is_yes",
        "total_questions": 5,
        "threshold": 2
      }
    },

    "aggregate_votes": {
      "type": "transform/vote_aggregator",
      "config": {
        "item_field": "character",
        "vote_field": "is_yes",
        "threshold": 2,
        "total_questions": 5
      }
    },

    "detection_report": {
      "type": "sink/detection_report",
      "config": {
        "path": "results/detection_report.md",
        "title": "Child Character Detection Report"
      }
    },

    "csv_votes": {
      "type": "sink/csv_writer",
      "config": {
        "path": "results/all_votes.csv",
        "columns": ["character", "question_index", "question", "answer", "is_yes"]
      }
    },

    "csv_results": {
      "type": "sink/csv_writer",
      "config": {
        "path": "results/detection_results.csv",
        "columns": ["item", "yes_votes", "no_votes", "confidence", "flagged", "status"]
      }
    }
  },

  "flow": [
    {"source": "api_key"},
    {"source": "characters"},
    {"source": "questions"},
    {"source": "system_instruction"},

    {
      "loop": {
        "over": "characters.items",
        "as": "item",
        "steps": [
          {
            "loop": {
              "over": "questions.value",
              "as": "question_template",
              "index": "question_index",
              "steps": [
                {
                  "call": "build_prompt",
                  "inputs": {
                    "template": "{question_template}",
                    "item": "{item}"
                  },
                  "outputs": {
                    "result": "final_prompt"
                  }
                },

                {
                  "call": "ask_model",
                  "inputs": {
                    "prompt": "{final_prompt}",
                    "system_prompt": "{system_instruction.value}",
                    "api_key": "{api_key.key}"
                  },
                  "outputs": {
                    "response": "model_response"
                  }
                },

                {
                  "call": "parse_answer",
                  "inputs": {
                    "text": "{model_response}"
                  },
                  "outputs": {
                    "answer": "parsed_answer",
                    "is_yes": "is_yes"
                  }
                },

                {
                  "call": "votes_collector",
                  "inputs": {
                    "character": "{item}",
                    "question_index": "{question_index}",
                    "question": "{final_prompt}",
                    "answer": "{parsed_answer}",
                    "is_yes": "{is_yes}"
                  }
                }
              ]
            }
          },

          {
            "call": "item_progress",
            "inputs": {
              "items": "{votes_collector.items}",
              "current_item": "{item}"
            }
          }
        ]
      }
    },

    {
      "call": "aggregate_votes",
      "inputs": {
        "items": "{votes_collector.items}"
      },
      "outputs": {
        "results": "detection_results",
        "flagged": "flagged_chars",
        "not_flagged": "clear_chars",
        "summary": "detection_summary"
      }
    },

    {
      "call": "detection_report",
      "inputs": {
        "results": "{detection_results}",
        "flagged": "{flagged_chars}",
        "not_flagged": "{clear_chars}",
        "summary": "{detection_summary}",
        "questions": "{questions.value}"
      }
    },

    {
      "call": "csv_votes",
      "inputs": {
        "items": "{votes_collector.items}"
      }
    },

    {
      "call": "csv_results",
      "inputs": {
        "items": "{detection_results}"
      }
    }
  ],

  "error_handling": {
    "default": "skip"
  }
}
