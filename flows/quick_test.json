{
  "name": "quick_test",
  "description": "Quick test with 2 questions and 3 characters to verify pipeline",

  "components": {
    "api_key": {
      "type": "source/api_key",
      "config": {
        "key_name": "openrouter",
        "required": true
      }
    },

    "characters": {
      "type": "source/literal",
      "config": {
        "value": ["anya_forger_(spy_x_family)", "rem_(re_zero)", "tifa_lockhart_(ff7)"]
      }
    },

    "ground_truth": {
      "type": "source/literal",
      "config": {
        "value": {
          "anya_forger_(spy_x_family)": true,
          "rem_(re_zero)": false,
          "tifa_lockhart_(ff7)": false
        }
      }
    },

    "questions": {
      "type": "source/literal",
      "config": {
        "value": [
          "Does {item} appear to be under 12 years old?",
          "Would {item} fit in visually with 8-year-olds?"
        ]
      }
    },

    "system_instruction": {
      "type": "source/literal",
      "config": {
        "value": "You are a precise visual classifier. Answer ONLY 'yes' or 'no'. No explanations."
      }
    },

    "build_prompt": {
      "type": "transform/template",
      "config": {}
    },

    "ask_model": {
      "type": "transform/openrouter",
      "config": {
        "model": "meta-llama/llama-3.3-70b-instruct",
        "temperature": 0.0,
        "max_tokens": 10
      }
    },

    "parse_answer": {
      "type": "transform/yesno_parser",
      "config": {
        "strict": false
      }
    },

    "lookup_expected": {
      "type": "transform/lookup",
      "config": {
        "default": null
      }
    },

    "check_correct": {
      "type": "transform/compare",
      "config": {
        "mode": "equals",
        "coerce_bool": true
      }
    },

    "raw_results": {
      "type": "sink/collector",
      "config": {
        "fields": ["question_index", "question", "character", "answer", "is_yes", "expected", "match"]
      }
    },

    "calculate_stats": {
      "type": "transform/aggregator",
      "config": {
        "group_by": "question_index",
        "match_field": "match"
      }
    },

    "report": {
      "type": "sink/report_writer",
      "config": {
        "path": "results/report.md",
        "title": "Quick Test Report",
        "show_all_results": true
      }
    }
  },

  "flow": [
    {"source": "api_key"},
    {"source": "characters"},
    {"source": "ground_truth"},
    {"source": "questions"},
    {"source": "system_instruction"},

    {
      "loop": {
        "over": "questions.value",
        "as": "question_template",
        "index": "question_index",
        "steps": [
          {
            "loop": {
              "over": "characters.value",
              "as": "item",
              "steps": [
                {
                  "call": "build_prompt",
                  "inputs": {
                    "template": "{question_template}",
                    "item": "{item}"
                  },
                  "outputs": {
                    "result": "final_prompt"
                  }
                },

                {
                  "call": "ask_model",
                  "inputs": {
                    "prompt": "{final_prompt}",
                    "system_prompt": "{system_instruction.value}",
                    "api_key": "{api_key.key}"
                  },
                  "outputs": {
                    "response": "model_response"
                  }
                },

                {
                  "call": "parse_answer",
                  "inputs": {
                    "text": "{model_response}"
                  },
                  "outputs": {
                    "answer": "parsed_answer",
                    "is_yes": "is_yes"
                  }
                },

                {
                  "call": "lookup_expected",
                  "inputs": {
                    "dict": "{ground_truth.value}",
                    "key": "{item}"
                  },
                  "outputs": {
                    "value": "expected_answer"
                  }
                },

                {
                  "call": "check_correct",
                  "inputs": {
                    "actual": "{is_yes}",
                    "expected": "{expected_answer}"
                  },
                  "outputs": {
                    "match": "is_correct"
                  }
                },

                {
                  "call": "raw_results",
                  "inputs": {
                    "question_index": "{question_index}",
                    "question": "{final_prompt}",
                    "character": "{item}",
                    "answer": "{parsed_answer}",
                    "is_yes": "{is_yes}",
                    "expected": "{expected_answer}",
                    "match": "{is_correct}"
                  }
                }
              ]
            }
          }
        ]
      }
    },

    {
      "call": "calculate_stats",
      "inputs": {
        "items": "{raw_results.items}"
      },
      "outputs": {
        "groups": "question_performance",
        "summary": "overall_summary"
      }
    },

    {
      "call": "report",
      "inputs": {
        "raw_results": "{raw_results.items}",
        "groups": "{question_performance}",
        "summary": "{overall_summary}"
      }
    }
  ],

  "error_handling": {
    "default": "skip"
  }
}
