{
  "name": "tag_filter_debate",
  "description": "Multi-model debate for filter classification - identifies contested tags needing human review",

  "settings": {
    "output_mode": "normal"
  },

  "components": {
    "api_key": {
      "type": "source/api_key",
      "config": {
        "key_name": "openrouter",
        "required": true
      }
    },

    "tags": {
      "type": "source/text_list",
      "config": {
        "path": "flows/samples/small_filter_test.txt"
      }
    },

    "categories": {
      "type": "source/literal",
      "config": {
        "value": ["male_presence", "anal_content", "non_human_partner", "violence_gore", "bodily_waste", "extreme_fetish", "pubic_hair", "pass"]
      }
    },

    "models": {
      "type": "source/literal",
      "config": {
        "value": [
          "openai/gpt-4.1-mini",
          "anthropic/claude-sonnet-4",
          "google/gemini-2.5-flash-preview-09-2025",
          "meta-llama/llama-4-maverick",
          "deepseek/deepseek-v3.2"
        ]
      }
    },

    "system_instruction": {
      "type": "source/literal",
      "config": {
        "value": "You are classifying anime/illustration tags for a female-solo content filter. Return ONLY the category name or 'pass'.\n\nFILTER CATEGORIES:\n- male_presence: Male anatomy, male characters, hetero acts (penis, balls, 1boy, hetero, fellatio, cum_on_face)\n- anal_content: Any anal-related (anal, anus, anal_sex, spread_anus)\n- non_human_partner: Creature PARTNERS not character types (tentacles, furry, monster - but elf/succubus/demon as CHARACTER is OK)\n- violence_gore: Blood, wounds, death (blood, gore, corpse, dismemberment)\n- bodily_waste: Excrement, urine, vomit (scat, poop, urine, watersports)\n- extreme_fetish: Extreme body mod, forced scenarios (inflation, forced_lactation, milking_machine, rape)\n- pubic_hair: Pubic hair tags (pubic_hair, shaved_pussy)\n- pass: Tag is acceptable (female anatomy, pleasure, BDSM, toys, fantasy races)\n\nRespond with ONLY the category name. One word."
      }
    },

    "arbitrator_instruction": {
      "type": "source/literal",
      "config": {
        "value": "Multiple AI models disagreed on classifying this tag for a female-solo content filter. Review their votes and decide the correct category. Consider: is this tag depicting male involvement, creature partners, violence, waste, extreme content, or is it acceptable female-solo content? Answer with ONLY the category name."
      }
    },

    "build_prompt": {
      "type": "transform/template",
      "config": {}
    },

    "ask_model": {
      "type": "transform/openrouter",
      "config": {
        "temperature": 0.0,
        "max_tokens": 20,
        "timeout": 30
      }
    },

    "parse_category": {
      "type": "transform/category_parser",
      "config": {
        "default_category": "unknown"
      }
    },

    "votes_collector": {
      "type": "sink/collector",
      "config": {
        "fields": ["tag", "model", "category", "matched", "raw_response"]
      }
    },

    "check_consensus": {
      "type": "transform/category_consensus",
      "config": {
        "item_field": "tag",
        "category_field": "category",
        "model_field": "model",
        "majority_threshold": 0.5
      }
    },

    "build_debate_prompt": {
      "type": "transform/template",
      "config": {}
    },

    "arbitrator": {
      "type": "transform/openrouter",
      "config": {
        "model": "openai/gpt-4.1",
        "temperature": 0.0,
        "max_tokens": 20,
        "timeout": 60
      }
    },

    "parse_arbitration": {
      "type": "transform/category_parser",
      "config": {
        "default_category": "unknown"
      }
    },

    "final_collector": {
      "type": "sink/collector",
      "config": {
        "fields": ["tag", "final_category", "consensus_type", "vote_counts", "model_votes"]
      }
    },

    "report": {
      "type": "sink/json_writer",
      "config": {
        "path": "filter_debate_results.json"
      }
    }
  },

  "flow": [
    {"source": "api_key"},
    {"source": "tags"},
    {"source": "categories"},
    {"source": "models"},
    {"source": "system_instruction"},
    {"source": "arbitrator_instruction"},

    {
      "loop": {
        "over": "tags.items",
        "as": "tag",
        "steps": [
          {
            "loop": {
              "over": "models.value",
              "as": "model_name",
              "steps": [
                {
                  "call": "build_prompt",
                  "inputs": {
                    "template": "Classify this tag: {tag}",
                    "tag": "{tag}"
                  },
                  "outputs": {
                    "result": "classification_prompt"
                  }
                },

                {
                  "call": "ask_model",
                  "inputs": {
                    "prompt": "{classification_prompt}",
                    "system_prompt": "{system_instruction.value}",
                    "api_key": "{api_key.key}",
                    "model": "{model_name}"
                  },
                  "outputs": {
                    "response": "model_response"
                  }
                },

                {
                  "call": "parse_category",
                  "inputs": {
                    "text": "{model_response}",
                    "categories": "{categories.value}"
                  },
                  "outputs": {
                    "category": "voted_category",
                    "matched": "vote_matched"
                  }
                },

                {
                  "call": "votes_collector",
                  "inputs": {
                    "tag": "{tag}",
                    "model": "{model_name}",
                    "category": "{voted_category}",
                    "matched": "{vote_matched}",
                    "raw_response": "{model_response}"
                  }
                }
              ]
            }
          }
        ]
      }
    },

    {"sink": "votes_collector"},

    {
      "call": "check_consensus",
      "inputs": {
        "votes": "{votes_collector.items}"
      },
      "outputs": {
        "results": "consensus_results",
        "agreed": "agreed_items",
        "disputed": "disputed_items",
        "summary": "consensus_summary"
      }
    },

    {
      "loop": {
        "over": "agreed_items",
        "as": "agreed",
        "steps": [
          {
            "call": "final_collector",
            "inputs": {
              "tag": "{agreed.item}",
              "final_category": "{agreed.final_category}",
              "consensus_type": "{agreed.consensus_type}",
              "vote_counts": "{agreed.vote_counts}",
              "model_votes": "{agreed.model_votes}"
            }
          }
        ]
      }
    },

    {
      "loop": {
        "over": "disputed_items",
        "as": "dispute",
        "steps": [
          {
            "call": "build_debate_prompt",
            "inputs": {
              "template": "Tag: {tag}\n\nModel votes:\n{votes}\n\nCategories: male_presence, anal_content, non_human_partner, violence_gore, bodily_waste, extreme_fetish, pubic_hair, pass\n\nCorrect category:",
              "tag": "{dispute.item}",
              "votes": "{dispute.model_votes}"
            },
            "outputs": {
              "result": "debate_prompt"
            }
          },

          {
            "call": "arbitrator",
            "inputs": {
              "prompt": "{debate_prompt}",
              "system_prompt": "{arbitrator_instruction.value}",
              "api_key": "{api_key.key}"
            },
            "outputs": {
              "response": "arbitrator_response"
            }
          },

          {
            "call": "parse_arbitration",
            "inputs": {
              "text": "{arbitrator_response}",
              "categories": "{categories.value}"
            },
            "outputs": {
              "category": "arbitrated_category"
            }
          },

          {
            "call": "final_collector",
            "inputs": {
              "tag": "{dispute.item}",
              "final_category": "{arbitrated_category}",
              "consensus_type": "disputed",
              "vote_counts": "{dispute.vote_counts}",
              "model_votes": "{dispute.model_votes}"
            }
          }
        ]
      }
    },

    {"sink": "final_collector"},

    {
      "call": "report",
      "inputs": {
        "data": {
          "summary": "{consensus_summary}",
          "all_votes": "{votes_collector.items}",
          "final_results": "{final_collector.items}"
        }
      }
    }
  ],

  "error_handling": {
    "default": "retry",
    "max_retries": 3
  }
}
